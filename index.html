<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Учет задач и оплат</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <style>
        .card-header {
            background-color: #6c5ce7;
            color: white;
        }
        .btn-primary {
            background-color: #6c5ce7;
            border-color: #6c5ce7;
        }
        .stats-card {
            background-color: #f8f9fa;
            border-left: 4px solid #6c5ce7;
        }
        .table-responsive {
            max-height: 50vh;
            overflow-y: auto;
        }
        .month-group {
            background-color: #e9ecef;
            font-weight: bold;
        }
        .paid {
            color: #28a745;
        }
        .unpaid {
            color: #dc3545;
        }
        .task-row {
            transition: background-color 0.3s;
        }
        .task-row:hover {
            background-color: #f8f9fa;
        }
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container py-4">
        <header class="text-center mb-4">
            <h1 class="display-5">Учет задач и оплат</h1>
            <p class="lead">Отслеживайте выполнение задач и выплаты</p>
        </header>

        <!-- Блок с общей информацией -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Общая статистика</span>
                <select id="monthFilter" class="form-select form-select-sm" style="width: auto;">
                    <option value="all">Все месяцы</option>
                </select>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-3">
                        <div class="stats-card p-3 rounded">
                            <h6>Задач в работе</h6>
                            <h4 id="totalTasks" class="mb-0">0</h4>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="stats-card p-3 rounded">
                            <h6>Часы</h6>
                            <h4 id="totalHours" class="mb-0">0</h4>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="stats-card p-3 rounded">
                            <h6>Общая сумма</h6>
                            <h4 id="totalAmount" class="mb-0">0 ₽</h4>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="stats-card p-3 rounded">
                            <h6>Получено</h6>
                            <h4 id="totalPaid" class="mb-0">0 ₽</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

        <!-- Кнопки управления -->
        <div class="row mb-4">
            <div class="col-6">
                <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#taskModal">
                    <i class="fas fa-plus me-2"></i>Добавить задачу
                </button>
            </div>
            <div class="col-6">
                <button class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#paymentModal">
                    <i class="fas fa-ruble-sign me-2"></i>Учесть оплату
                </button>
            </div>
        </div>

        <!-- Таблица задач -->
<div class="row">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header">
                <span>Список задач и оплат</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Задача</th>
                                <th>Часы</th>
                                <th>Ставка</th>
                                <th>Стоимость</th>
                                <th>Оплачено</th>
                                <th>Статус</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="tasksTable">
                            <!-- Задачи будут здесь -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- Модальное окно добавления задачи -->
    <div class="modal fade" id="taskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Добавить задачу</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="taskForm">
                        <div class="mb-3">
                            <label class="form-label">Название задачи *</label>
                            <input type="text" class="form-control" id="taskName" required>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="form-label">Дата начала *</label>
                                <input type="date" class="form-control" id="startDate" required>
                            </div>
                            <div class="col-6">
                                <label class="form-label">Дата выполнения *</label>
                                <input type="date" class="form-control" id="endDate" required>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="form-label">Часы *</label>
                                <input type="number" class="form-control" id="hours" min="0" step="0.5" required>
                            </div>
                            <div class="col-6">
                                <label class="form-label">Ставка (₽/час) *</label>
                                <input type="number" class="form-control" id="hourlyRate" min="0" required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" onclick="addTask()">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно добавления оплаты -->
    <div class="modal fade" id="paymentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Учесть оплату</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="paymentForm">
                        <div class="mb-3">
                            <label class="form-label">Задача *</label>
                            <select class="form-select" id="paymentTask" required>
                                <option value="">Выберите задачу</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Сумма оплаты (₽) *</label>
                            <input type="number" class="form-control" id="paymentAmount" min="0" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Дата оплаты *</label>
                            <input type="date" class="form-control" id="paymentDate" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" onclick="addPayment()">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // Хранение данных
    let tasks = [];
    let payments = [];

    // Инициализация приложения
    document.addEventListener('DOMContentLoaded', function() {
        // Загружаем данные из localStorage
        tasks = JSON.parse(localStorage.getItem('tasks')) || [];
        payments = JSON.parse(localStorage.getItem('payments')) || [];
        
        updateStats();
        renderTasksTable();
        populateMonthFilter();
        updatePaymentTaskDropdown();
        
        // Установка текущей даты по умолчанию
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('startDate').value = today;
        document.getElementById('endDate').value = today;
        document.getElementById('paymentDate').value = today;
    });

    // Добавление задачи
    function addTask() {
        const taskName = document.getElementById('taskName').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const hours = parseFloat(document.getElementById('hours').value);
        const hourlyRate = parseFloat(document.getElementById('hourlyRate').value);

        if (!taskName || !startDate || !endDate || isNaN(hours) || isNaN(hourlyRate)) {
            alert('Пожалуйста, заполните все обязательные поля');
            return;
        }

        const task = {
            id: Date.now(),
            name: taskName,
            startDate: startDate,
            endDate: endDate,
            hours: hours,
            hourlyRate: hourlyRate,
            cost: hours * hourlyRate,
            paidAmount: 0
        };

        tasks.push(task);
        saveData();
        updateStats();
        renderTasksTable();
        populateMonthFilter();
        updatePaymentTaskDropdown();
        
        // Закрытие модального окна и сброс формы
        bootstrap.Modal.getInstance(document.getElementById('taskModal')).hide();
        document.getElementById('taskForm').reset();
    }

    // Добавление оплаты
    function addPayment() {
        const taskId = parseInt(document.getElementById('paymentTask').value);
        const amount = parseFloat(document.getElementById('paymentAmount').value);
        const paymentDate = document.getElementById('paymentDate').value;

        if (!taskId || isNaN(amount) || !paymentDate) {
            alert('Пожалуйста, заполните все обязательные поля');
            return;
        }

        const payment = {
            id: Date.now(),
            taskId: taskId,
            amount: amount,
            date: paymentDate
        };

        payments.push(payment);

        // Обновление суммы оплаты для задачи
        const task = tasks.find(t => t.id === taskId);
        if (task) {
            task.paidAmount = (task.paidAmount || 0) + amount;
        }

        saveData();
        updateStats();
        renderTasksTable();
        populateMonthFilter();
        updatePaymentTaskDropdown();
        
        // Закрытие модального окна и сброс формы
        bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
        document.getElementById('paymentForm').reset();
    }

    // Удаление задачи
    function deleteTask(taskId) {
        if (!confirm('Вы уверены, что хотите удалить эту задачу? Все связанные оплаты также будут удалены.')) {
            return;
        }

        // Удаляем задачу
        tasks = tasks.filter(task => task.id !== taskId);
        
        // Удаляем связанные оплаты
        payments = payments.filter(payment => payment.taskId !== taskId);

        saveData();
        updateStats();
        renderTasksTable();
        populateMonthFilter();
        updatePaymentTaskDropdown();
    }

    // Обновление выпадающего списка задач для оплаты
    function updatePaymentTaskDropdown() {
        const dropdown = document.getElementById('paymentTask');
        dropdown.innerHTML = '<option value="">Выберите задачу</option>';
        
        tasks.forEach(task => {
            const totalPaid = payments.filter(p => p.taskId === task.id)
                .reduce((sum, p) => sum + p.amount, 0);
            
            if (totalPaid < task.cost) {
                const option = document.createElement('option');
                option.value = task.id;
                option.textContent = `${task.name} (Осталось: ${(task.cost - totalPaid).toFixed(2)} ₽)`;
                dropdown.appendChild(option);
            }
        });
    }

    // Обновление статистики
    function updateStats() {
        const selectedMonth = document.getElementById('monthFilter').value;
        let filteredTasks = tasks;
        let filteredPayments = payments;

        if (selectedMonth !== 'all') {
            filteredTasks = tasks.filter(task => {
                const taskMonth = task.endDate.substring(0, 7); // YYYY-MM
                return taskMonth === selectedMonth;
            });

            filteredPayments = payments.filter(payment => {
                const paymentMonth = payment.date.substring(0, 7);
                return paymentMonth === selectedMonth;
            });
        }

        const totalTasks = filteredTasks.length;
        const totalHours = filteredTasks.reduce((sum, task) => sum + task.hours, 0);
        const totalAmount = filteredTasks.reduce((sum, task) => sum + task.cost, 0);
        const totalPaid = filteredPayments.reduce((sum, payment) => sum + payment.amount, 0);

        document.getElementById('totalTasks').textContent = totalTasks;
        document.getElementById('totalHours').textContent = totalHours.toFixed(1);
        document.getElementById('totalAmount').textContent = totalAmount.toFixed(2) + ' ₽';
        document.getElementById('totalPaid').textContent = totalPaid.toFixed(2) + ' ₽';
    }

    // Отображение таблицы задач
    function renderTasksTable() {
        const table = document.getElementById('tasksTable');
        table.innerHTML = '';

        // Группировка задач по месяцам
        const tasksByMonth = {};
        tasks.forEach(task => {
            const month = task.endDate.substring(0, 7); // YYYY-MM
            if (!tasksByMonth[month]) {
                tasksByMonth[month] = [];
            }
            tasksByMonth[month].push(task);
        });

        // Сортировка месяцев по убыванию
        const sortedMonths = Object.keys(tasksByMonth).sort().reverse();

        sortedMonths.forEach(month => {
            // Заголовок месяца
            const monthRow = document.createElement('tr');
            monthRow.className = 'month-group';
            monthRow.innerHTML = `
                <td colspan="7">
                    ${getMonthName(month)} ${month.substring(0,4)}
                </td>
            `;
            table.appendChild(monthRow);

            // Задачи месяца
            tasksByMonth[month].forEach(task => {
                const taskPayments = payments.filter(p => p.taskId === task.id);
                const totalPaid = taskPayments.reduce((sum, p) => sum + p.amount, 0);
                const status = totalPaid >= task.cost ? 'Оплачено' : 'Не оплачено';

                const row = document.createElement('tr');
                row.className = 'task-row';
                row.innerHTML = `
                    <td>${task.name}</td>
                    <td>${task.hours}</td>
                    <td>${task.hourlyRate} ₽</td>
                    <td>${task.cost.toFixed(2)} ₽</td>
                    <td>${totalPaid.toFixed(2)} ₽</td>
                    <td class="${status === 'Оплачено' ? 'paid' : 'unpaid'}">${status}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteTask(${task.id})" title="Удалить задачу">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                table.appendChild(row);

                // Детали оплат
                if (taskPayments.length > 0) {
                    taskPayments.forEach(payment => {
                        const paymentRow = document.createElement('tr');
                        paymentRow.className = 'table-light';
                        paymentRow.innerHTML = `
                            <td colspan="5" class="small text-muted">Оплата: ${new Date(payment.date).toLocaleDateString()}</td>
                            <td class="small text-muted">+${payment.amount.toFixed(2)} ₽</td>
                            <td></td>
                        `;
                        table.appendChild(paymentRow);
                    });
                }
            });
        });

        // Если задач нет, показываем сообщение
        if (tasks.length === 0) {
            const emptyRow = document.createElement('tr');
            emptyRow.innerHTML = `
                <td colspan="7" class="text-center text-muted py-4">
                    <i class="fas fa-tasks fa-2x mb-2"></i>
                    <p>Нет добавленных задач</p>
                </td>
            `;
            table.appendChild(emptyRow);
        }
    }

    // Заполнение фильтра месяцев
    function populateMonthFilter() {
        const filter = document.getElementById('monthFilter');
        const currentValue = filter.value; // Сохраняем текущее значение
        
        // Очищаем все опции кроме "Все месяцы"
        while (filter.options.length > 1) {
            filter.remove(1);
        }

        const months = new Set();

        // Добавляем месяцы из задач
        tasks.forEach(task => {
            if (task.endDate) {
                months.add(task.endDate.substring(0, 7));
            }
        });

        // Добавляем месяцы из оплат
        payments.forEach(payment => {
            if (payment.date) {
                months.add(payment.date.substring(0, 7));
            }
        });

        // Сортировка и добавление в фильтр
        Array.from(months).sort().reverse().forEach(month => {
            const option = document.createElement('option');
            option.value = month;
            option.textContent = `${getMonthName(month)} ${month.substring(0,4)}`;
            filter.appendChild(option);
        });

        // Восстанавливаем предыдущее значение или устанавливаем "all"
        if (filter.querySelector(`option[value="${currentValue}"]`)) {
            filter.value = currentValue;
        } else {
            filter.value = 'all';
        }
    }

    // Вспомогательная функция для получения названия месяца
    function getMonthName(monthString) {
        const date = new Date(monthString + '-01');
        return date.toLocaleString('ru-RU', { month: 'long' });
    }

    // Сохранение данных в localStorage
    function saveData() {
        localStorage.setItem('tasks', JSON.stringify(tasks));
        localStorage.setItem('payments', JSON.stringify(payments));
    }

    // Обработчик изменения фильтра
    document.getElementById('monthFilter').addEventListener('change', updateStats);
</script>
</body>
</html>
